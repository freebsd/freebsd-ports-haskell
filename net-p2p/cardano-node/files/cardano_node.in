#!/bin/sh

# PROVIDE: cardano_node
# REQUIRE: DAEMON
# KEYWORD: shutdown
#
# Add the following lines to /etc/rc.conf to enable this service:
#
# cardano_node_enable:      Set to YES to enable cardano-node.
#                           Default: "NO"
#
# cardano_node_home:        An absolute path to the daemon home directory.
#                           The directory will be created if not exists.
#                           Default: "/var/db/cardano_node"
#
# cardano_node_net:         A network name to connect to.
#                           Default: "mainnet"
#
# cardano_node_port:        Port to listen for connections on.
#                           Default: "6000"
#
# Advanced settings that usually don't need to be changed for simple usage cases:
#
# cardano_node_host:        Host address to bind to.
#                           Default: "0.0.0.0"
#
#
# cardano_node_socket:      An absolute path to the daemon socket file.
#                           Default: "${cardano_node_home}/cardano-node.sock"
#
# cardano_node_db:          An absolute path to the database directory.
#                           Default: "${cardano_node_home}/${cardano_node_net}-db"
#
# cardano_node_topology:    An absolute or a relative to ${cardano_node_home} path
#                           to the topology JSON file.
#                           Default: "${cardano_node_net}-configs/${cardano_node_net}-topology.json"
#
# cardano_node_config:      An absolute or a relative to ${cardano_node_home} path
#                           to the cardano-node config.json file.
#                           Default: "${cardano_node_net}-configs/${cardano_node_net}-config.json"
#
# cardano_node_rts_flags:   GHC runtime flags to be passed between "+RTS" and "-RTS".
#                           See https://downloads.haskell.org/ghc/latest/docs/html/users_guide/runtime_control.html
#                           for the meaning of these flags.
#                           Default: "-N -A64m -n4m -F1.2 -qg1"
#
# cardano_node_flags:       Any additional command line flags to pass to cardano-node.
#                           Default: ""
#

. /etc/rc.subr

name=cardano_node
desc="Cardano Node daemon"
rcvar=cardano_node_enable
command=%%PREFIX%%/bin/cardano-node

cardano_deployment_url="https://hydra.iohk.io/job/Cardano/cardano-node/cardano-deployment/latest-finished/download/1"
cardano_config_files="config byron-genesis shelley-genesis alonzo-genesis topology"
cardano_networks="mainnet testnet"

start_cmd="${name}_start"
start_precmd="${name}_prestart"
stop_cmd="${name}_stop"
status_cmd="${name}_status"
fetch_cmd="${name}_fetch"

extra_commands="status fetch"

load_rc_config $name
: ${cardano_node_enable:=NO}
: ${cardano_node_home:="/var/db/cardano_node"}
: ${cardano_node_net:="mainnet"}
: ${cardano_node_host:="0.0.0.0"}
: ${cardano_node_port:="6000"}
: ${cardano_node_socket:="${cardano_node_home}/cardano-node.sock"}
: ${cardano_node_db:="${cardano_node_home}/${cardano_node_net}-db"}
: ${cardano_node_topology:="${cardano_node_net}-configs/${cardano_node_net}-topology.json"}
: ${cardano_node_config:="${cardano_node_net}-configs/${cardano_node_net}-config.json"}
: ${cardano_node_rts_flags:="-N -A64m -n4m -F1.2 -qg1"}
: ${cardano_node_flags:=""}

cardano_node_jail="${cardano_node_home}/jail"
jail_topology="/topology_dir/`basename ${cardano_node_topology}`"
jail_config="/config_dir/`basename ${cardano_node_config}`"
jail_socket="/socket/`basename ${cardano_node_socket}`"
# TODO: exec.jail_user=cardano
jail_cmd="jail -c name=${name}_jail path=${cardano_node_jail} ip4=inherit ip6=inherit host=inherit"

pidfile="/var/run/cardano-node.pid"
logfile="/var/log/cardano-node.log"
flags="run +RTS ${cardano_node_rts_flags} -RTS \
        --database-path /db \
        --host-addr ${cardano_node_host} \
        --port ${cardano_node_port} \
        --socket-path ${jail_socket} \
        --topology ${jail_topology} \
        --config ${jail_config} \
        ${cardano_node_flags}"

sanity_check()
{
    if [ ! -f "${cardano_node_home}/${cardano_node_topology}" -a ! -f "/${cardano_node_topology}" ]
    then
        echo "Invalid value for cardano_node_topology: missing file ${cardano_node_topology}"
        echo "You might want to run service cardano_node onefetch"
        exit 1
    fi
    if [ ! -f "${cardano_node_home}/${cardano_node_config}" -a ! -f "/${cardano_node_config}" ]
    then
        echo "Invalid value for cardano_node_config: missing file ${cardano_node_config}"
        echo "You might want to run service cardano_node onefetch"
        exit 1
    fi
    return 0
}

_jail_dirs="/bin /etc /lib /libexec /socket"
_jail_mount_points="/dev /config_dir /topology_dir /db /logs"

create_jail()
{
    destroy_jail

    for d in ${_jail_dirs} ${_jail_mount_points}
    do
        mkdir -p "${cardano_node_jail}${d}"
    done

    cp /etc/resolv.conf "${cardano_node_jail}/etc/"
    cp /etc/services "${cardano_node_jail}/etc/"

    echo "cardano:*:100:100::0:0:Cardano Node daemon:/nonexistent:/nologin" > "${cardano_node_jail}/etc/master.passwd"
    pwd_mkdb -d "${cardano_node_jail}/etc" -p "${cardano_node_jail}/etc/master.passwd"

    cp "$command" "${cardano_node_jail}/bin/"
    ldd "$command" | cut -s -d " " -f 3 | grep -E '^(/lib|/usr)' | sort -u | xargs -I % cp % "${cardano_node_jail}/lib/"
    cp /libexec/ld-elf.so.1 "${cardano_node_jail}/libexec"

    # change directory because $cardano_node_{config,topology} may be relative paths
    cd ${cardano_node_home}
    mount_nullfs -o ro `dirname ${cardano_node_config}` "${cardano_node_jail}/config_dir"
    mount_nullfs -o ro `dirname ${cardano_node_topology}` "${cardano_node_jail}/topology_dir"
    mount_nullfs "${cardano_node_db}" "${cardano_node_jail}/db"
    mount_nullfs "${cardano_node_home}/logs" "${cardano_node_jail}/logs"
    mount -o ruleset=4 -t devfs devfs "${cardano_node_jail}/dev"
}

destroy_jail()
{
    for d in ${_jail_mount_points}
    do
        if [ -d "${cardano_node_jail}${d}" ]; then
            umount -f "${cardano_node_jail}${d}" 2> /dev/null
        fi
    done
    for d in ${_jail_dirs}
    do
        rm -rf "${cardano_node_jail}${d}"
    done
    for d in ${_jail_mount_points}
    do
        rmdir "${cardano_node_jail}${d}" 2> /dev/null
    done

    rmdir "${cardano_node_jail}" 2> /dev/null
}

cardano_node_prestart()
{
    # Create Cardano home directory, if not exists
    if [ ! -d "${cardano_node_home}" ]; then
        mkdir -p "${cardano_node_home}"
    fi
    # Do the same for the logs directory
    if [ ! -d "${cardano_node_home}/logs" ]; then
        mkdir -p "${cardano_node_home}/logs"
    fi
    
    # Remove the symlink to the socket file if there is no pid file
    if [ -L "${cardano_node_socket}" -a ! -f $pidfile ]; then
        rm "${cardano_node_socket}"
    fi

    sanity_check
}

cardano_node_start()
{
    check_startmsgs && echo "Starting ${name}."

    create_jail
    if [ "$?" != "0" ]
    then
        echo "Failed to start ${name}: jail creation error"
        return 1
    fi
    cd $cardano_node_home && /usr/sbin/daemon -p $pidfile -o ${logfile} \
        ${jail_cmd} command=/bin/cardano-node ${flags} 2>&1 > /dev/null
    ln -s "${cardano_node_jail}/${jail_socket}" "${cardano_node_socket}"
}

cardano_node_stop()
{
    pid=$(check_pidfile "${pidfile}" jail)
    if [ -z "${pid}" ]
    then
        echo "${name} is not running"
        destroy_jail
        return 1
    else
        echo "Stopping ${name}."
        killall -j ${name}_jail -INT
        wait_for_pids "$pid"
        destroy_jail
        rm ${cardano_node_socket}
    fi
}

cardano_node_status()
{
    pid=$(check_pidfile "${pidfile}" jail)
    if [ -z "${pid}" ]
    then
        echo "${name} is not running"
        return 1
    else
        echo ${name} is running as pid $pid
    fi
}

cardano_node_fetch()
{
    for net in ${cardano_networks}
    do
        echo "Fetching configuration files for ${net}"
        mkdir -p "${cardano_node_home}/${net}-configs"
        mkdir -p "${cardano_node_home}/${net}-db"
        /usr/bin/apply "/usr/bin/fetch -a -o ${cardano_node_home}/${net}-configs ${cardano_deployment_url}/${net}-%1.json" $cardano_config_files
    done
}

run_rc_command "$1"
